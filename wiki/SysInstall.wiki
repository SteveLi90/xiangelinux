#labels Featured
#安装弦歌Linux

= 0.简介 =

本文介绍了安装弦歌Linux的步骤。


= 1.安装需求 =

||硬件需求||任何Linux支持的硬件系统，目前只在PC机上测试<br>5G以上的硬盘空间<br>128MB以上的内存||
    

= 2.安装方式 =
弦歌Linux支持2种安装方式: 手动安装和自动脚本安装。无论何种方式，都调用弦歌的包管理系统gpkg, 请参见文档[xgpkg].

= 3.手动安装 =
手动安装即通过手动的方式安装所有软件包，如先调用gpkg -i linux-header 安装所有Linux头文件， 再调用gpkg -i glibc 安装C库， 再调用gpkg -i bin-utils安装二进制工具链。安装的步骤和LFS手册类似，只是细节交给gpkg处理。

具体步骤如下:
===3.1 准备主分区 ===

    * 首先需要一个主分区，至少5G以上。可以用fdisk/cfdisk从硬盘空闲空间生成，也可以使用现有无用分区。
    * 格式化主分区, 推荐使用ext4. 
    * 挂载到/mnt/xg 目录，作为工作目录。
    * 如果不想使用分区， 可以直接找一个目录代替，如~/xg, 作为工作目录。

===3.2 准备交换分区 ===
    * 弦歌系统基于源码安装，有大量的编译工作，如果有多于1GB的内存, 且启动tmpfs, 编译工作在tmpfs(可以理解为内存)中完成，可以大大提高编译速度，延长硬盘使用寿命。
    * tmpfs需要5G左右，如果你有2G内存，再加上3G的交换分区即可。
    * 用fdisk/cfdisk创建一个交换分区，然后用mkswap/swapon命令启动。
    * 也可以用文件代替交换分区，只是性能不如直接使用交换分区。
    * 交换分区启动后， 可以执行free命令看看容量:
{{{
free
             total       used       free     shared    buffers     cached
Mem:       2073332     375920    1697412          0      21224     159492
-/+ buffers/cache:     195204    1878128
Swap:     10738048          0   10738048
}}}

    * 有足够大空间的化， 可以在/etc/fstab里启动tmpfs
{{{
tmpfs           /dev/shm        tmpfs   defaults,size=10G       0       0
}}}

    * 挂载/dev/shm后，执行df -h命令， 可以看到:
{{{
sword@OPSvr ~ $df -h
文件系统              容量  已用 可用 已用% 挂载点
/dev/sdb7              97G  7.1G   85G   8% /
/dev/sdb6             100G   25G   76G  25% /mnt/bak
tmpfs                  10G  8.0K   10G   1% /dev/shm
}}}

    * 接着将tmpfs挂接到工作目录:
{{{
mkdir /dev/shm/xgtmp
chmod 1777 /dev/shm/xgtmp
mkdir /mnt/xg/tmp
mount --bind /dev/shm/xgtmp /mnt/xg/tmp
}}}

===3.3 准备工具链 (/tools目录) ===
    * 可以直接下载工具链，在根目录解压，即可跳过此步骤。
    * 若想自己重新编译工具链，步骤如下:
        # 下载编译脚本 xgstage0.tar.bz2
        # 在工作目录解压, 得到xgstage0目录。进入后执行./download，脚本会自动下载所需软件包源码
        # 如果失败，可以手动下载源码到工作目录的var/xiange/sources子目录, 如 /mnt/xg/var/xiange/sources/abc.tar.bz2. 在此运行./download, 会跳过已下载的软件包。
        # 下载成功后，执行./build, 构建工具链。
        # 完成后，会得到一个完整的工具链，在/mnt/xg/tools目录下。里面有记录文件installed.log, 记录了每个软件包的名称和安装时间。
        # 其实..也不必完全等代./download下载完毕再执行./build. 下载完gcc后就可以执行了，然后边下载边编译，节省时间。

    安装工具列表: (名称/安装时间)
{{{
binutils-2.19.1 2010-04-16 15:46:44
gcc-4.4.0 2010-04-16 17:09:43
linux-2.6.32.11 2010-04-16 17:10:22
glibc-2.10.1 2010-04-16 17:30:07
tcl8.5.7 2010-04-16 17:31:23
expect-5.43 2010-04-16 17:31:33
dejagnu-1.4.4 2010-04-16 17:31:41
gcc-4.4.0-pass2 2010-04-16 17:53:10
binutils-2.19.1-pass2 2010-04-16 17:56:39
ncurses-5.7 2010-04-16 17:58:54
bash-4.0 2010-04-16 18:02:48
bzip2-1.0.5 2010-04-16 18:02:54
coreutils-7.4 2010-04-16 10:05:01
diffutils-2.8.1 2010-04-16 10:05:23
e2fsprogs-1.41.7 2010-04-16 10:06:23
findutils-4.4.2 2010-04-16 10:07:47
gawk-3.1.6 2010-04-16 10:08:21
gettext-0.17 2010-04-16 10:10:38
grep-2.5.4 2010-04-16 10:10:58
gzip-1.3.12 2010-04-16 10:11:14
m4-1.4.13 2010-04-16 10:11:52
make-3.81 2010-04-16 10:12:14
patch-2.5.9 2010-04-16 10:12:28
perl-5.10.0 2010-04-16 10:14:37
sed-4.2.1 2010-04-16 10:14:59
tar-1.22 2010-04-16 10:15:52
texinfo-4.13 2010-04-16 10:16:30
util-linux-ng-2.15.1 2010-04-16 10:16:52
zlib-1.2.3 2010-04-16 10:16:57
git-1.6.3.3 2010-04-16 10:18:13
wget-1.11.4 2010-04-16 10:18:34
gpkg-0.10.1 2010-04-16 10:18:34
}}}
    gpkg-0.10.1 可以从本站下载。

    
        

===3.4 chroot到工作环境 ===
    * 拷贝/etc/resolv.conf 到/mnt/xg/etc目录, 保证chroot后可以访问网络。
    * 可以将一下命令写入脚本 doxg, 以后每次执行chroot时都需要做这些..
{{{
       
        mount /dev/XXXX /mnt/xg

        mkdir -p /mnt/xg/proc
        mkdir -p /mnt/xg/sys
        mkdir -p /mnt/xg/dev
        mount -t proc none /mnt/xg/proc
        mount -t sysfs none /mnt/xg/sys
        mount --bind /dev /mnt/xg/dev

        #copy resolv.conf
        [ -d /mnt/xg/etc ] || mkdir /mnt/xg/etc
        [ -f /mnt/xg/etc/resolv.conf ] || cp /etc/resolv.conf /mnt/xg/etc


        #tmpfs 如果编译tools前已经挂载了，这步可以省掉
        mkdir /dev/shm/xgtmp
        chmod 1777 /dev/shm/xgtmp
        mount --bind /dev/shm/xgtmp /mnt/xg/tmp

        echo "xg: Mount OK"
        #chroot
        chroot /mnt/xg /tools/bin/env -i \
                HOME=/root TERM="$TERM" PS1='\u:\w\$ ' \
                PATH=/bin:/usr/bin:/sbin:/usr/sbin:/tools/bin \                
               /tools/bin/bash
}}}

      成功后，能看到如下信息:
{{{
I have no name!:/# ls
dev  lost+found  proc  sys  tmp  tools	var  xgstage0
I have no name!:/# 

}}}



===3.5 更新编译脚本库 ===
    * 在chroot的环境里,执行gpkg --sync, 可以看到如下信息:
{{{
I have no name!:/etc# gpkg --sync
Initialized empty Git repository in /var/xiange/xglibs/.git/
remote: Counting objects: 26, done.
remote: Compressing objects: 100% (20/20), done.
remote: Total 26 (delta 5), reused 0 (delta 0)
Receiving objects: 100% (26/26), done.
Resolving deltas: 100% (5/5), done.
I have no name!:/etc# 

}}}

===3.6 安装baselayout ===
    * 执行gpkg -s base 检查能否从库中找到baselayout
    * 执行gpkg -i baselayout 安装baselayout
    * 安装完毕后，执行gpkg -I 检查所有已经安装的软件包
    * 执行 gpkg -l baselayout列出包中所有文件。

===3.7 安装linux-headers ===

    
===3.8 这时可以自由运行gpkg, 安装需要的软件包。===
    * 每装完一个包，都可以用qpkg 查看安装信息，可以对系统了如指掌。
    *继续安装，知道整个系统可以脱离/tools直接运行。

===3.9 准备启动===
    * 设置密码，
    * 修改fstab
    * 编译内核，
    * 安装GRUB2 或 GRUB
    * 重新启动



= 4.自动脚本安装 =
自动脚本安装通过脚本文件，自动调用gpkg安装所需软件包。自动安装时支持4中安装情景，称为情景0(又称Stage0), 情景1, 情景2, 情景3. 介绍如下:

||情景||简介||
||Stage0||完全从0开始安装，只需下载安装脚本，指定安装的目的分区(或目的目录),运行脚本即可。<br>脚本自动下载所需软件包，从头构建工具链，构建根系统，安装软件包，直至系统完成。||
||Stage1||比Stage0简化些，不需在本地构建工具链。预下载内容包括工具链和安装脚本。<br>指定安装的目的分区(或目的目录),运行脚本。<br>脚本自动下载所需软件包，构建根系统，安装软件包，直至系统完成。||
||Stage2||比Stage1简化些，不需要额外的工具链。预下载内容包括跟文件系统，已预装好编译环境和包管理系统。<br>用户只需要在此基础上, 调用gpkg安装自己喜欢的软件包即可。||
||Stage3||Stage2的扩充，包括X系统, gtk2, qt4, fvwm, firefox等预装软件包。||

用户可以根据需求，从任何一种情景开始安装。情景0和情景1需要编译构建根系统，情景2和情景3解压后直接得到根系统。
根系统准备好后，编译内核，安装Grub, 创建用户，设置密码，然后重新启动即可。